function test(support) {
  // If the test has already passed, return a resolved promise.
  if (test.HAS_LOCAL_STORAGE && window.localStorage.getItem('odovideoautoplay') === 'true') {
    return Promise.resolve(true);
  }

  // Retrieve the number of autoplay test attempts. Max is 3.
  const tries = test.HAS_LOCAL_STORAGE && parseInt(window.localStorage.getItem('odovideoautoplaytries'), 10) || 0;
  if (tries > 2) {
    return Promise.resolve(false);
  }

  /* istanbul ignore next */
  return new Promise((resolve) => {
    let timeout;

    // Chrome can handle 300ms. IE11 requires at least 900 to avoid failing consistenly.
    const waitTime = 1000;
    const elem = document.createElement('video');
    const elemStyle = elem.style;

    const complete = (bool) => {
      if (test.HAS_LOCAL_STORAGE) {
        window.localStorage.setItem('odovideoautoplay', bool);
        window.localStorage.setItem('odovideoautoplaytries', tries + 1);
      }

      resolve(bool);
    };

    const testAutoplay = (arg) => {
      clearTimeout(timeout);
      elem.removeEventListener('playing', testAutoplay);
      complete(arg && arg.type === 'playing' || elem.currentTime !== 0);
      elem.parentNode.removeChild(elem);
    };

    // Skip the test if video itself, or the autoplay element on it isn't supported.
    if (!support || !('autoplay' in elem)) {
      complete(false);
      return;
    }

    elemStyle.position = 'absolute';
    elemStyle.display = 'none';
    elemStyle.height = 0;
    elemStyle.width = 0;
    elem.src = 'data:video/mp4;base64,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AGxzdGNvAAAAAAAAABcAAAq3AAAK2gAACvIAAAsKAAALJwAAC0AAAAtYAAALcAAAC40AAAunAAALvwAAC9cAAAv0AAAMDgAADCYAAAw+AAAMWwAADHUAAAyNAAAMpQAADMIAAAzaAAAM8gAAAGF1ZHRhAAAAWW1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALGlsc3QAAAAkqXRvbwAAABxkYXRhAAAAAQAAAABMYXZmNTQuNi4xMDAAAAVJbWRhdAAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxMjUgcjEzNSsxTSAxN2RlOWJmIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxMiAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTUgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MzoweDExMyBtZT11bWggc3VibWU9OCBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0xIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MSA4eDhkY3Q9MSBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0tMiB0aHJlYWRzPTEyIGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MyBiX3B5cmFtaWQ9MiBiX2FkYXB0PTIgYl9iaWFzPTAgZGlyZWN0PTMgd2VpZ2h0Yj0xIG9wZW5fZ29wPTAgd2VpZ2h0cD0yIGtleWludD0yNTAga2V5aW50X21pbj0yNCBzY2VuZWN1dD00MCBpbnRyYV9yZWZyZXNoPTAgcmNfbG9va2FoZWFkPTUwIHJjPWNyZiBtYnRyZWU9MSBjcmY9MjIuMCBxY29tcD0wLjYwIHFwbWluPTAgcXBtYXg9NjkgcXBzdGVwPTQgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAABdliIQAV/1HwAFPzwKZhb5yjvmigTYuUQAAAAhBmiRsRX+rgN4CAExhdmM1NC4yMy4xMDAAQiAIwRg4AAAACEGeQjiK/+WBIRAEYIwcIRAEYIwcAAAACAGeYTRFf+WAIRAEYIwcIRAEYIwcAAAACAGeY2pFf+WBIRAEYIwcIRAEYIwcAAAADUGaaEmoQWiZTAivq4EhEARgjBwhEARgjBwAAAAJQZ6GLlExX+WBIRAEYIwcIRAEYIwcAAAACAGepSkRX+WBIRAEYIwcIRAEYIwcAAAACAGep25Ff+WAIRAEYIwcIRAEYIwcAAAADUGarDUILakymARXq4AhEARgjBwhEARgjBwAAAAKQZ7KJJREXFflgSEQBGCMHCEQBGCMHAAAAAgBnukpEV/lgCEQBGCMHCEQBGCMHAAAAAgBnutuRX/lgCEQBGCMHCEQBGCMHAAAAA1BmvA1CC2pMpgEV6uBIRAEYIwcIRAEYIwcAAAACkGfDiSURFxX5YEhEARgjBwhEARgjBwAAAAIAZ8tKRFf5YEhEARgjBwhEARgjBwAAAAIAZ8vbkV/5YAhEARgjBwhEARgjBwAAAANQZs0NQgtqTKYBFergCEQBGCMHCEQBGCMHAAAAApBn1IklERcV+WBIRAEYIwcIRAEYIwcAAAACAGfcSkRX+WAIRAEYIwcIRAEYIwcAAAACAGfc25Ff+WAIRAEYIwcIRAEYIwcAAAADUGbdzUILakymARXq4EhEARgjBwhEARgjBwAAAAIQZ+WJIiv5YAhEARgjBwhEARgjBwAAAAIAZ+1LRFf5YEhEARgjBwhEARgjBwhEARgjBwhEARgjBwhEARgjBwhEARgjBwhEARgjBw=';

    elem.setAttribute('autoplay', '');
    elem.setAttribute('muted', '');
    elem.setAttribute('playsinline', '');
    document.documentElement.appendChild(elem);

    // Wait for the next tick to add the listener, otherwise the element may
    // not have time to play in high load situations (e.g. the test suite).
    setTimeout(() => {
      elem.addEventListener('playing', testAutoplay);
      timeout = setTimeout(testAutoplay, waitTime);
    }, 0);
  });
}

// Support: Safari private browsing.
test.HAS_LOCAL_STORAGE = (() => {
  try {
    const testKey = 'test';
    window.localStorage.setItem(testKey, '1');
    window.localStorage.removeItem(testKey);
    return true;
  } catch (error) /* istanbul ignore next */ {
    return false;
  }
})();

export default test;
